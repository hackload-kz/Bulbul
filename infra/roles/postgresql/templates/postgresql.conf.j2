# PostgreSQL configuration file
# Performance-tuned for high load

#------------------------------------------------------------------------------
# CONNECTIONS AND AUTHENTICATION
#------------------------------------------------------------------------------

listen_addresses = '{{ postgresql_listen_addresses }}'
port = {{ postgresql_port }}
max_connections = {{ postgresql_max_connections }}
authentication_timeout = {{ postgresql_authentication_timeout }}

#------------------------------------------------------------------------------
# RESOURCE USAGE (except WAL)
#------------------------------------------------------------------------------

# Memory
shared_buffers = {{ postgresql_shared_buffers }}
work_mem = {{ postgresql_work_mem }}
maintenance_work_mem = {{ postgresql_maintenance_work_mem }}
effective_cache_size = {{ postgresql_effective_cache_size }}

# Kernel Resource Usage
max_files_per_process = 1000

#------------------------------------------------------------------------------
# WRITE AHEAD LOG
#------------------------------------------------------------------------------

wal_buffers = {{ postgresql_wal_buffers }}
checkpoint_completion_target = {{ postgresql_checkpoint_completion_target }}
max_wal_size = {{ postgresql_max_wal_size }}
min_wal_size = {{ postgresql_min_wal_size }}

#------------------------------------------------------------------------------
# QUERY TUNING
#------------------------------------------------------------------------------

# Planner Cost Constants
random_page_cost = {{ postgresql_random_page_cost }}
effective_io_concurrency = {{ postgresql_effective_io_concurrency }}

# Other Planner Options
enable_partitionwise_join = on
enable_partitionwise_aggregate = on

#------------------------------------------------------------------------------
# ERROR REPORTING AND LOGGING
#------------------------------------------------------------------------------

log_destination = '{{ postgresql_log_destination }}'
logging_collector = {{ postgresql_logging_collector }}
log_directory = '{{ postgresql_log_directory }}'
log_filename = '{{ postgresql_log_filename }}'
log_min_duration_statement = {{ postgresql_log_min_duration_statement }}
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0

#------------------------------------------------------------------------------
# RUNTIME STATISTICS
#------------------------------------------------------------------------------

track_activities = {{ postgresql_track_activities }}
track_counts = {{ postgresql_track_counts }}
track_io_timing = {{ postgresql_track_io_timing }}
track_functions = {{ postgresql_track_functions }}

#------------------------------------------------------------------------------
# AUTOVACUUM PARAMETERS
#------------------------------------------------------------------------------

autovacuum = on
log_autovacuum_min_duration = 0
autovacuum_max_workers = 3
autovacuum_naptime = 20s
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05

#------------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
#------------------------------------------------------------------------------

# Statement Behavior
search_path = '"$user", public'
default_tablespace = ''

# Locale and Formatting
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'
default_text_search_config = 'pg_catalog.english'

#------------------------------------------------------------------------------
# SHARED LIBRARY PRELOADING
#------------------------------------------------------------------------------

shared_preload_libraries = 'pg_stat_statements'

#------------------------------------------------------------------------------
# PERFORMANCE OPTIMIZATIONS
#------------------------------------------------------------------------------

# Checkpoint settings for write-heavy workloads
checkpoint_timeout = 10min
checkpoint_warning = 30s

# Background writer
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0

# WAL writer
wal_writer_delay = 200ms

# Archive settings (disabled by default)
archive_mode = off

# SSL (if needed)
ssl = {{ postgresql_ssl }}

# Connection pooling preparation
max_prepared_transactions = 0

# Parallel processing
max_worker_processes = 8
max_parallel_workers_per_gather = 2
max_parallel_workers = 8
max_parallel_maintenance_workers = 2